stages:
  - test
  - build
  - deploy

variables:
  # Disable TLS for docker-in-docker (used in build_job)
  DOCKER_TLS_CERTDIR: ""

# Run tests on commits to the dev branch
test_job:
  stage: test
  image: node:20-alpine
  script:
    - npm ci
    - npm test
  only:
    - dev

# Build docker images only on the main branch
build_job:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - docker info || true
  script:
    - docker build -f Dockerfile.dev -t "$CI_PROJECT_NAME:dev" .
    - docker build -f Dockerfile.prod -t "$CI_PROJECT_NAME:prod" .
    - echo "Built images: $CI_PROJECT_NAME:dev and $CI_PROJECT_NAME:prod"
  only:
    - main
  tags: []
  retry: 1
  privileged: true

# Simulated deploy step (manual) on main
deploy_job:
  stage: deploy
  image: node:20
  # This job builds the site and deploys the built `dist/` to an S3 bucket.
  # It expects these CI/CD variables to be set in the project Settings > CI/CD > Variables:
  #   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION, S3_BUCKET
  script:
    - echo "Deploy: install deps and build"
    - npm ci --silent
    - npm run build
    - echo "Installing awscli"
    - apt-get update -y && apt-get install -y python3-pip groff-base
    - pip3 install --upgrade awscli
    - export PATH=$PATH:~/.local/bin
    - echo "Syncing dist/ to s3://$S3_BUCKET"
    - aws s3 sync dist/ s3://$S3_BUCKET --delete --acl public-read
    - |
      if [ -n "$CF_DISTRIBUTION_ID" ]; then
        echo "Invalidating CloudFront distribution $CF_DISTRIBUTION_ID"
        aws cloudfront create-invalidation --distribution-id $CF_DISTRIBUTION_ID --paths "/*"
      else
        echo "No CloudFront distribution configured; skipping invalidation"
      fi
  only:
    - main
  when: on_success
